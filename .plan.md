# Plan: Add Recursive Directory Support to ORAS Push

## Overview

This plan addresses [GitHub Issue #1871](https://github.com/oras-project/oras/issues/1871) - adding hierarchical directory representation using OCI Image Indexes alongside OCI Image Manifests. The current implementation bundles directories into tarballs, preventing selective file access and causing scalability issues.

## Problem Statement

Current limitations:
1. Directories are bundled into single TAR.GZIP blobs - no selective file access
2. Large directories (>2,000 files) cause registry timeouts when pushed as single manifests
3. No deduplication across different push operations - identical files are re-uploaded
4. Cannot list directory contents without downloading entire tarball

## Proposed Solution

Implement a `--recursive` flag for `oras push` that creates a hierarchical OCI structure:

- **File-only directories**: Single Image Manifest with individual file layers
- **Directory-only directories**: Image Index linking to nested Indexes/Manifests
- **Mixed directories**: Image Index containing both a Manifest (for files) and nested Indexes (for subdirectories)

### Example Structure

```
my-repo/
├── file1.txt
├── file2.txt
└── subdir/
    ├── file3.txt
    └── nested/
        └── file4.txt
```

Becomes:
```
Image Index (root)
├── Manifest (file1.txt, file2.txt as layers)
└── Image Index (subdir/)
    ├── Manifest (file3.txt as layer)
    └── Image Index (nested/)
        └── Manifest (file4.txt as layer)
```

## Implementation Steps

### Phase 1: Core Infrastructure

#### Step 1.1: Add new option types for recursive push
- **File**: `cmd/oras/internal/option/recursive.go` (new)
- **Changes**:
  - Create `Recursive` struct with flags: `--recursive`, `--max-blobs-per-manifest`, `--preserve-structure`
  - Add validation methods
  - Document flag usage

#### Step 1.2: Create directory walker utility
- **File**: `internal/dir/walker.go` (new directory and file)
- **Changes**:
  - Implement recursive directory traversal
  - Return structured tree representation
  - Support filtering (glob patterns, .gitignore-style exclusions)
  - Track file vs directory nodes

#### Step 1.3: Create hierarchical manifest builder
- **File**: `internal/manifest/builder.go` (new directory and file)
- **Changes**:
  - Implement logic to create OCI Image Manifests for file groups
  - Implement logic to create OCI Image Indexes for directory groupings
  - Handle mixed directories (files + subdirectories)
  - Support `--max-blobs-per-manifest` chunking

### Phase 2: Push Command Integration

#### Step 2.1: Extend push command with recursive option
- **File**: `cmd/oras/root/push.go`
- **Changes**:
  - Add `--recursive` flag to command
  - Add `--max-blobs-per-manifest` flag (default: 1000, for scalability)
  - Integrate `Recursive` option struct
  - Update command description and examples

#### Step 2.2: Implement recursive file loading
- **File**: `cmd/oras/root/file.go`
- **Changes**:
  - Modify `loadFiles()` to detect when `--recursive` is set
  - Implement `loadFilesRecursive()` function
  - Walk directory tree using new walker utility
  - Create individual file descriptors (not tarball)

#### Step 2.3: Implement hierarchical push logic
- **File**: `cmd/oras/root/push.go`
- **Changes**:
  - Add `runPushRecursive()` function as alternative to current `runPush()`
  - Build manifest/index tree from directory structure
  - Push bottom-up (leaf directories first, then parents)
  - Handle annotations at directory and file levels

### Phase 3: Annotations and Metadata

#### Step 3.1: Define standard annotations for recursive structures
- **File**: `internal/descriptor/annotations.go` (new)
- **Changes**:
  - Define annotation keys for:
    - Directory path: `org.oras.directory.path`
    - Original filename: `org.oras.file.name`
    - Directory depth level: `org.oras.directory.level`
    - Parent reference: `org.oras.directory.parent`
  - Document annotation schema

#### Step 3.2: Extend annotation file support
- **File**: `cmd/oras/internal/option/packer.go`
- **Changes**:
  - Support wildcard patterns in annotation files (e.g., `"*.txt": {...}`)
  - Support directory-level annotations (e.g., `"subdir/": {...}`)
  - Validate recursive annotation patterns

### Phase 4: Progress Reporting and UX

#### Step 4.1: Enhance progress display for recursive operations
- **File**: `cmd/oras/internal/display/status/progress/status.go`
- **Changes**:
  - Show directory tree structure during push
  - Display per-directory progress
  - Show total files vs completed files
  - Handle deeply nested structures gracefully

#### Step 4.2: Add verbose output for manifest structure
- **File**: `cmd/oras/root/push.go`
- **Changes**:
  - With `--verbose`, display created manifest/index hierarchy
  - Show digest for each created manifest
  - Log skipped files (already exist with same digest)

### Phase 5: Pull Command Support (Future Scope)

#### Step 5.1: Extend pull for recursive artifacts
- **File**: `cmd/oras/root/pull.go`
- **Changes**:
  - Detect recursive structure via annotations
  - Reconstruct directory hierarchy on pull
  - Support selective subdirectory pull (`--filter-path`)

*Note: This step is documented for completeness but may be implemented in a follow-up PR.*

### Phase 6: Testing

#### Step 6.1: Unit tests for new utilities
- **Files**:
  - `internal/dir/walker_test.go`
  - `internal/manifest/builder_test.go`
  - `internal/descriptor/annotations_test.go`
- **Coverage**:
  - Directory walker with various structures
  - Manifest builder edge cases
  - Annotation parsing

#### Step 6.2: Unit tests for push modifications
- **File**: `cmd/oras/root/push_test.go`
- **Changes**:
  - Test `--recursive` flag parsing
  - Test `loadFilesRecursive()` function
  - Test hierarchical manifest creation
  - Test max-blobs-per-manifest chunking

#### Step 6.3: E2E tests
- **File**: `test/e2e/suite/command/push.go` (or new file)
- **Coverage**:
  - Push recursive directory to local registry
  - Verify manifest structure with `oras manifest fetch`
  - Pull and verify directory reconstruction
  - Test deduplication (push same content twice)
  - Test large directory handling (>1000 files)

### Phase 7: Documentation

#### Step 7.1: Update command help
- **File**: `cmd/oras/root/push.go`
- **Changes**:
  - Add examples for recursive push
  - Document `--recursive` and `--max-blobs-per-manifest` flags
  - Add notes about compatibility

#### Step 7.2: Update repository documentation
- **File**: Documentation files (location TBD based on project conventions)
- **Changes**:
  - Document recursive push feature
  - Provide use case examples
  - Document annotation schema

## Design Decisions

### 1. Backward Compatibility
- `--recursive` is opt-in; default behavior unchanged
- Existing pushed directories (as tarballs) remain valid
- New format uses standard OCI constructs (Index + Manifest)

### 2. Scalability Approach
- Default max 1000 blobs per manifest (configurable)
- Deep directories create deeper index trees rather than flat large manifests
- Files split across multiple manifests if directory exceeds limit

### 3. Deduplication
- Leverage existing content-addressable storage
- Files with identical content share same blob
- Only unique content uploaded, regardless of file path

### 4. Annotation Schema
- Use `org.oras.` namespace for new annotations
- Maintain compatibility with existing `io.deis.oras.` annotations
- Store enough metadata to reconstruct directory on pull

## Open Questions for Discussion

1. **Chunking Strategy**: When a directory exceeds `--max-blobs-per-manifest`, should we:
   - Split alphabetically?
   - Split by size to balance chunks?
   - Allow user-defined grouping?

2. **Empty Directories**: Should empty directories be represented? (Probably yes, via annotations on an empty manifest)

3. **Symlinks**: How to handle symlinks?
   - Follow them (current tarball behavior)?
   - Store as symlink annotations?
   - Error on symlinks?

4. **Pull Behavior**: Should recursive artifacts be pulled differently by default, or use existing pull with automatic detection?

## Files to Create/Modify Summary

### New Files
- `cmd/oras/internal/option/recursive.go`
- `internal/dir/walker.go`
- `internal/dir/walker_test.go`
- `internal/manifest/builder.go`
- `internal/manifest/builder_test.go`
- `internal/descriptor/annotations.go`
- `internal/descriptor/annotations_test.go`

### Modified Files
- `cmd/oras/root/push.go`
- `cmd/oras/root/file.go`
- `cmd/oras/internal/option/packer.go`
- `cmd/oras/internal/display/status/progress/status.go`
- `cmd/oras/root/push_test.go`
- E2E test files

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Registry compatibility | Use only standard OCI constructs (Index, Manifest) |
| Performance with large dirs | Chunking via `--max-blobs-per-manifest`, parallel uploads |
| Breaking existing workflows | Feature is opt-in via `--recursive` flag |
| Complexity of pull reconstruction | Store sufficient metadata in annotations |

## Success Criteria

1. `oras push --recursive localhost:5000/repo:tag ./mydir` creates hierarchical OCI structure
2. Individual files are accessible without downloading entire directory
3. Directories with >2000 files push without timeout
4. Identical files are deduplicated within repository
5. All existing tests pass
6. New feature has >80% test coverage
